
version: "3.9"
services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: otp
      POSTGRES_PASSWORD: otp
      POSTGRES_DB: otp
    volumes: [db_data:/var/lib/postgresql/data]
  redis:
    image: redis:7-alpine
  api:
    build: .
    environment:
      DATABASE_URL: postgresql+psycopg2://otp:otp@db:5432/otp
      REDIS_URL: redis://redis:6379/0
      PUBLIC_BASE_URL: https://$DOMAIN
      FRONTEND_BASE_URL: https://$DOMAIN
      API_TOKEN: ${API_TOKEN}
    depends_on: [db, redis]
  worker:
    build: .
    command: python -m server.worker
    environment:
      DATABASE_URL: postgresql+psycopg2://otp:otp@db:5432/otp
      REDIS_URL: redis://redis:6379/0
    depends_on: [db, redis]
  web:
    build:
      context: ./webapp
      dockerfile: Dockerfile
    command: ["npm","run","build-export"]
    environment:
      NEXT_PUBLIC_API_BASE: https://$DOMAIN
    volumes:
      - web_out:/out
  nginx:
    image: nginx:alpine
    ports: ["80:80", "443:443"]
    volumes:
      - ./ops/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - web_out:/usr/share/nginx/html:ro
      - certbot_www:/var/www/certbot
      - certbot_etc:/etc/letsencrypt
    depends_on: [api, web]
  certbot:
    image: certbot/certbot
    volumes:
      - certbot_www:/var/www/certbot
      - certbot_etc:/etc/letsencrypt
    entrypoint: sh -c "trap exit TERM; while :; do sleep 12h & wait $${!}; certbot renew; done"
volumes:
  db_data: {}
  web_out: {}
  certbot_www: {}
  certbot_etc: {}
